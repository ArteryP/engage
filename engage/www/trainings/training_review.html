{% extends "templates/custom_web.html" %}

{% macro render_breadcrumbs() %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/trainings/">Trainings</a></li>
    <li class="breadcrumb-item"><a href="/trainings/{{ t.name }}/">{{ t.title }}</a></li>
    <li class="breadcrumb-item active">Review</li>
  </ol>
</nav>
{% endmacro %}

{% macro NavigationButtons(previousLink, previousText, middleText, nextLink, nextText) %}
<ul class="pagination pagination-sm justify-content-center">
    <li class="page-item {{ previousLink if previousLink else "disabled" }} w-100">
      <a id="prev-link" class="page-link" href="{{ previousLink if previousLink else "#" }}" tabindex="-1"><i class="fa-solid fa-arrow-left"></i> {{ previousText }}</a>
    </li>
    <li class="page-item active">
	<a class="page-link">{{ middleText }}</a>
    </li>
    <li class="page-item {{ nextLink if nextLink else "disabled" }} w-100 text-right">
      <a id="next-link" class="page-link" href="{{ nextLink if nextLink else "#" }}">{{ nextText }}<i class="fa-solid fa-arrow-right"></i></a>
    </li>
</ul>
{% endmacro %}

{% macro Sidebar() %}
<div class="sidebar">
  <div class="card">
    <div class="d-flex justify-content-between card-body">
      <div class="h5 card-title">Participants</div>
      <div>
	<a class="text-decoration-none" href="/trainings/{{ t.name }}/review"><i class="fa-solid fa-arrows-rotate"></i></a>
      </div>
    </div>

    <ul class="list-group list-group-flush">
      {% for p in participants %}
      <a class="list-group-item list-group-item-action participant-review-link {{'active' if p.active}}"
	 href="/trainings/{{t.name}}/review?p={{ p.user }}">
	{{p.full_name}} - {{p.num_solved}}
      </a>
      {% endfor %}
    </ul>

  </div>

</div>
{% endmacro %}

{% macro ProblemSet(pset) %}
<div class="my-5">
  <h3>{{ pset.title }}</h3>
  <div>
    {% for p in pset.problems %}
    <button type="button" class="btn btn-problem btn-sm {{ 'btn-success' if p.solution else 'btn-light'}}"
			  data-target="#problem-{{p.name}}">
      {{p.title}}
    </button>
    {% endfor %}
  </div>
</div>
{% endmacro %}

{% macro ProblemSets() %}
<div class="row">
  <div class="col-md-4">
    <ul class="list-group">
      {% for ps in problem_sets %}
      <span class="list-group-item"><strong>{{ps.title}}</strong></span>
      {% for p in ps.problems %}
      <a class="list-group-item list-group-item-action problem-link" href="javascript:;" id="problem-{{ p.name }}"
											 data-title='{{ p.title }}'
											 data-description='{{ frappe.utils.md_to_html(p.description) | e }}'
											 data-code='{{ p.code | e }}'
											 data-next="{{ loop.nextitem.name if loop.nextitem else '' }}"
											 data-next-title="{{ loop.nextitem.title if loop.nextitem else '' }}"
											 data-prev="{{ loop.previtem.name if loop.previtem else '' }}"
											 data-prev-title="{{ loop.previtem.title if loop.previtem else '' }}"
											 data-problem-name="{{ p.name }}">
	<svg class="icon icon-sm">
	  {% if not p.solution %}
	  {% elif p.solution.test_outcome == "passed" %}
	  <use href="#icon-tick"></use>
	  {% elif p.solution.test_outcome == "failed" %}
	  <use href="#icon-close"></use>
	  {% else %}
	  {% endif %}
	</svg>
	{{p.title}}
      </a>
      {% endfor %}
      {% endfor %}
    </ul>
  </div>

  <div class="col-md-8 problem-page">
    <nav id="nav-participant" class="mb-6 w-100">
	{% if not (prev_participant or next_participant) %}
	{% set next_participant = first_participant %}
	{% endif %}

	{% set name_length = 24 %}
	{{ NavigationButtons(get_participant_review_link(prev_participant), get_participant_full_name(prev_participant, name_length), "Participant", get_participant_review_link(next_participant), get_participant_full_name(next_participant, name_length)) }}
    </nav>

    <h5 id="problem-title"></h5>
    <div id="problem-description" class="problem-description"></div>

    <pre id="problem-code" style="background: #eeeedd; padding: 20px; border-radius: 10px;"><em class="m-0 p-0">Select a problem to see its code.</em></pre>

    <nav id="nav-problem" class="my-2" data-first-problem="{{ first_problem }}">
    </nav>
  </div>

</div>
{% endmacro %}

{% macro TrainingBody() %}
<div class="row">
  <div class="col-md-9">
    <div class="training-body">
      {{ ProblemSets() }}
    </div>
  </div>
  <div class="col-md-3">
    {{ Sidebar() }}
  </div>
</div>
{% endmacro %}

{% block page_content %}
<div class="training-page">
  {{ render_breadcrumbs() }}

  <div class="training-header">
    <div class="h2">{{t.title}}</div>
    <div class="training-dates">{{frappe.utils.format_date(t.begin_date, "MMM dd")}} - {{
      frappe.utils.format_date(t.end_date, "MMM dd") }}, {{t.end_date.year}}</div>
    <div>
      <div>{{client.title}}</div>
    </div>
    {% if trainers|length > 1 %}
    {% set other_trainers = trainers|selectattr("user", "!=", frappe.session.user) %}
    {# other_trainers = (t for t in trainers if t.user != frappe.session.user) #}
    <div>
      With
      {% for trainer in other_trainers %}
      {{trainer.full_name}}{% if not loop.last %},{% endif %}
      {% endfor %}
    </div>
    {% endif %}
  </div>
  {{ TrainingBody() }}
</div>
{% endblock %}
