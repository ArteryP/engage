{% extends "templates/custom_web.html" %}

{% macro render_breadcrumbs() %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/trainings/">Trainings</a></li>
    <li class="breadcrumb-item"><a href="/trainings/{{ training.name }}/">{{ training.title }}</a></li>
    <li class="breadcrumb-item active">Review</li>
  </ol>
</nav>
{% endmacro %}

{% macro NavigationButtons(previousLink, previousText, middleText, nextLink, nextText) %}
<ul class="pagination pagination-sm justify-content-center">
  <li class="page-item {{ previousLink if previousLink else " disabled" }} w-100">
    <a id="prev-link" class="page-link" href="{{ previousLink if previousLink else " #" }}" tabindex="-1"><i
        class="fa-solid fa-arrow-left"></i> {{ previousText }}</a>
  </li>
  <li class="page-item active">
    <a class="page-link">{{ middleText }}</a>
  </li>
  <li class="page-item {{ nextLink if nextLink else " disabled" }} w-100 text-right">
    <a id="next-link" class="page-link" href="{{ nextLink if nextLink else " #" }}">{{ nextText }}<i
        class="fa-solid fa-arrow-right"></i></a>
  </li>
</ul>
{% endmacro %}

{% macro Sidebar() %}
<div class="sidebar">
  <div class="card mt-0">
    <div class="d-flex justify-content-between card-body">
      <div class="h5 card-title">Participants</div>
    </div>

    <ul class="list-group list-group-flush">
      <li class="list-group-item d-flex justify-content-between">
        <span><strong>Name</strong></span>
        <span><strong>Solved</strong></span>
      </li>
      {% for p in training.participants %}
      <a class="list-group-item list-group-item-action participant-review-link {{ 'active' if p.active }}"
        href="/trainings/{{training.name}}/review?{{ dictupdate(q, updates={'participant': p.user}) | urlencode }}">
        <div class="d-flex justify-content-between">
          <span>{{ p.full_name }}</span>
          <span>{{ p.num_solved }}</span>
        </div>
      </a>
      {% endfor %}
    </ul>

  </div>

</div>
{% endmacro %}

{% macro ProblemSet(pset) %}
<div class="my-5">
  <h3>{{ pset.title }}</h3>
  <div>
    {% for p in pset.problems %}
    <button type="button" class="btn btn-problem btn-sm {{ 'btn-success' if p.solution else 'btn-light'}}"
      data-target="#problem-{{p.name}}">
      {{p.title}}
    </button>
    {% endfor %}
  </div>
</div>
{% endmacro %}

{% macro LeftSidebar() %}
<ul class="list-group">
  {% for ps in problem_sets %}
  <span class="list-group-item"><strong>{{ps.title}}</strong></span>
  {% for problem_ref in ps.problems %}
  <a class="list-group-item list-group-item-action problem-link {{ 'active' if problem_ref.problem == problem.name }}"
    href="/trainings/{{ training.name }}/review?{{ dictupdate(q, {'problem': problem_ref.problem})|urlencode() }}">
    <div class="d-flex justify-content-between">
      <span>
        <svg class="icon icon-sm">
          {% if not problem_ref.solution %}
          {% elif p.solution.test_outcome == "passed" %}
          <use href="#icon-tick"></use>
          {% elif p.solution.test_outcome == "failed" %}
          <use href="#icon-close"></use>
          {% else %}
          {% endif %}
        </svg>
        <span>{{problem_ref.problem_title}}</span>
      </span>
      {% if problem_ref.problem in user_submissions %}
      <span class="align-items-bottom">
        <i class="fa-solid fa-circle-check"></i>
      </span>
      {% endif %}
    </div>
  </a>
  {% endfor %}
  {% endfor %}
</ul>
{% endmacro %}

{% macro Problem(problem) %}
{% set submission = user_submissions.get(problem.name) %}
<div class="problem-page">
  {#<nav id="nav-participant" class="mb-6 w-100">
    {% if not (prev_participant or next_participant) %}
    {% set next_participant = first_participant %}
    {% endif %}

    {% set name_length = 24 %}
    {{ NavigationButtons(get_participant_review_link(prev_participant), get_participant_full_name(prev_participant,
    name_length), "Participant", get_participant_review_link(next_participant),
    get_participant_full_name(next_participant, name_length)) }}
  </nav>#}

  <div class="h5" id="problem-title">{{ problem.title }}</div>
  <div id="problem-description" class="problem-description">{{ frappe.utils.md_to_html(problem.description) }}</div>

  <pre id="problem-code" style="background: #eeeedd; padding: 20px; border-radius: 10px;">
    {%- if submission is none -%}
    <em>Not submitted</em>
    {%- else -%}
    {{ submission.code | e }}
    {%- endif -%}
  </pre>

  {% if submission.name %}
  <div id="problem-review-section">
    {% set doctype = "Practice Problem Latest Submission" %}
    {% set docname = submission.name %}
    {% set title = "Review Comments" %}
    {% set cta_title = "New Comment" %}
    {% set single_thread = True %}
    {% include "frappe/templates/discussions/discussions_section.html" %}
  </div>
  {% endif %}
</div>
{% endmacro %}

{% macro TrainingBody() %}
<div class="row">
  <div class="col-md-3">
    {{ LeftSidebar() }}
  </div>

  <div class="col-md-6">
    <div class="training-body mt-0">
      {{ Problem(problem) }}
    </div>
  </div>
  <div class="col-md-3">
    {{ Sidebar() }}
  </div>
</div>
{% endmacro %}

{% macro EmptyTrainingBody(need) %}
<em>Please add {{ need }} to the training</em>
{% endmacro %}

{% block page_content %}
<div class="training-page">
  {{ render_breadcrumbs() }}

  <div class="training-header">
    <div class="h2">{{training.title}}</div>
    <div class="training-dates">{{frappe.utils.format_date(training.begin_date, "MMM dd")}} - {{
      frappe.utils.format_date(training.end_date, "MMM dd") }}, {{training.end_date.year}}</div>
    <div>
      {% set client = frappe.get_doc("Client", training.client) %}
      <div>{{client.title}}</div>
    </div>
  </div>

  {% if not participant %}
  {{ EmptyTrainingBody("participants") }}
  {% elif not problem %}
  {{ EmptyTrainingBody("problems") }}
  {% else %}
  {{ TrainingBody() }}
  {% endif %}
</div>
{% endblock %}
